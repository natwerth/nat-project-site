<div class="lb-wrap">
<section class="letterboxd-reviews" aria-label="Latest Letterboxd Reviews">
 <style>
  /* ───────────────── tokens/hooks (uses your globals) ───────────────── */
  .lb-wrap{
    background: #fff;            /* background behind the container */
    margin: 1rem;                /* 1rem margins around the fragment */
    border-radius: var(--lb-radius, 14px);
  }
   .letterboxd-reviews{
    --lb-gap: var(--space-4, 16px);
    --lb-pad: var(--space-6, 24px);
    --lb-radius: var(--radius-lg, 14px);
    --lb-shadow: var(--shadow-sm, 0 6px 20px rgba(0,0,0,.06));
    --lb-accent: var(--brand-primary, #0E6839);
    --lb-card-bg: var(--footer-bg, #fdf8f4);
    --lb-card-fg: #111;
    --lb-max-lines: 4; /* visible lines before we append “see more…” */
    background: var(--footer-bg, #fdf8f4);
    border: 1px solid var(--color-border, rgba(0,0,0,.08));
    border-radius: var(--lb-radius, 14px);
    padding: 0;
    position: relative;
    overflow: hidden;
    color: var(--footer-text);
   }

  /* ───────────────── header ───────────────── */
   .lb-head{
    display:flex; align-items:baseline; justify-content:space-between; gap:12px;
    padding: 1rem;
   }
   .lb-head h2{ margin:0; color: var(--footer-text); padding-inline: 1rem; }

  /* ───────────────── horizontal scroller row ───────────────── */
   .lb-viewport{
    position:relative;
    max-width: 100%;
    overflow: hidden;
    contain: layout paint;
   }
   .lb-list{
    display:flex; gap: var(--lb-gap);
    overflow-x:auto; overflow-y:hidden; -webkit-overflow-scrolling:touch;
    scroll-snap-type:x mandatory; scroll-padding-inline: 1rem;
    padding-inline: 1rem;
    padding-top: 1rem;
    padding-bottom: 1rem;
    box-sizing: border-box;
    max-width: 100%;
    scrollbar-width: none;
    -ms-overflow-style: none;
   }
   .lb-list::-webkit-scrollbar{ width:0; height:0; }

  /* Tile sizing: one row, responsive widths */
   .lb-item{
    position:relative; isolation:isolate;
    flex: 0 0 auto;
    width: clamp(280px, 46vw, 520px);
    max-width: 100%;
    display:flex; gap:16px;
    background: var(--lb-card-bg); color: var(--lb-card-fg);
    border:1px solid var(--color-border, rgba(0,0,0,.08));
    border-radius: var(--lb-radius);
    padding: var(--space-4, 16px);
    box-shadow: var(--lb-shadow);
    scroll-snap-align:start;
    transition: transform .15s ease, box-shadow .15s ease, border-color .2s ease;
    align-items: flex-start;
   }
   .lb-item:hover{
    transform: translateY(-1px);
    box-shadow: var(--shadow-sm, 0 12px 32px rgba(0,0,0,.10));
    border-color: var(--color-border-strong, rgba(0,0,0,.15));
   }

  /* whole-card “hit” link */
   .lb-hit{
    position:absolute; inset:0; z-index:1; border-radius: inherit;
   }

  /* Poster */
   .lb-poster{
    position:relative; isolation:isolate;
    flex: 0 0 auto; width:72px; /* 2:3 => height resolves via pseudo */
    aspect-ratio: 2 / 3; /* modern browsers */
    border-radius: 10px; overflow:hidden; background:#f2f2f3;
    box-shadow: inset 0 2px 8px rgba(0,0,0,.06);
    align-self: flex-start;
  }
  /* Fallback to guarantee 2/3 even where aspect-ratio on flex items is flaky */
  .lb-poster::before{ content:""; display:block; padding-top:150%; }
  .lb-poster img{ position:absolute; inset:0; width:100%; height:100%; object-fit:cover; display:block; }

  /* Body */
   .lb-body{ display:flex; flex-direction:column; gap:10px; min-width:0; z-index:2; }
   .lb-title-row{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
   .lb-title-row a{ color:inherit; text-decoration:none; font-weight:800; font-size:1.06rem; }
   .lb-rating{ font: 600 .95rem/1 var(--font-sans, ui-sans-serif, system-ui); color:#444; }

  /* JS truncation target (no CSS clamp here) */
   .lb-desc{
    color:#222; line-height:1.5;
    display:block; overflow:hidden; /* height controlled by JS */
   }
   .lb-more{
    white-space:nowrap;
   }
   .lb-more a{
    color: var(--lb-accent); text-decoration:none; font-weight:600;
   }

   .lb-meta{ margin-top:auto; font-size:.85rem; color:#666; }
   .lb-meta a{ color: var(--lb-accent); text-decoration:none; }

  /* Controls bar */
   .lb-controls{
    display:flex; align-items:center; justify-content:space-between;
    gap:12px; margin-top: 12px;
    padding: 0 var(--lb-pad) var(--lb-pad);
   }
   .lb-arrows{
    display:inline-flex; gap:8px;
   }
   .lb-btn{
    display:inline-grid; place-items:center; width:36px; height:36px;
    border-radius: 999px; border:1px solid var(--color-border-strong, #0002);
    background:#fff; color:#111; cursor:pointer; user-select:none;
    box-shadow: var(--shadow-sm, 0 2px 8px rgba(0,0,0,.05));
    transition: transform .12s ease, box-shadow .15s ease, background .15s ease;
   }
   .lb-btn:hover{ transform: translateY(-1px); }
   .lb-btn:active{ transform: translateY(0); }
   .lb-dots{ display:flex; gap:8px; margin-left:auto; }
   .lb-dot{
    width:8px; height:8px; border-radius:999px; background:#0001; transition: transform .15s, background .15s;
   }
   .lb-dot[aria-current="true"]{ background: var(--lb-accent); transform: scale(1.2); }

  @media (max-width:720px){
   .lb-item{ width: 86vw; max-width: 100%; }
  }
 </style>

 <div class="lb-head">
  <h2>Movies</h2>
  <span class="lb-subtle" aria-hidden="true">via RSS + cloud worker</span>
 </div>

 <div class="lb-viewport">
  <div class="lb-list" id="lb-reviews" role="list"></div>

  <div class="lb-controls">
   <div class="lb-arrows">
    <button class="lb-btn" id="lb-prev" aria-label="Scroll previous">
     <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M15 6l-6 6 6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
    </button>
    <button class="lb-btn" id="lb-next" aria-label="Scroll next">
     <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M9 6l6 6-6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
    </button>
   </div>
   <div class="lb-dots" id="lb-dots" role="tablist" aria-label="Review positions"></div>
  </div>
 </div>

 <script>
  (async function letterboxdCarousel(){
   const url = "https://nat-letterboxd-proxy.nat-1fa.workers.dev/";
   const res = await fetch(url);
   const xmlText = await res.text();
   const xml = new DOMParser().parseFromString(xmlText, "application/xml");
   const items = [...xml.querySelectorAll("item")].slice(0, 8); // build a bit extra for scrolling

   const root = document.getElementById("lb-reviews");
   const dotsWrap = document.getElementById("lb-dots");
   const btnPrev = document.getElementById("lb-prev");
   const btnNext = document.getElementById("lb-next");

   root.innerHTML = "";

   const cards = [];
   items.forEach((item, i) => {
    const title = item.querySelector("title")?.textContent?.trim() || "Untitled";
    const link  = item.querySelector("link")?.textContent?.trim() || "#";
    const pub   = item.querySelector("pubDate")?.textContent || "";
    const descRaw = item.querySelector("description")?.textContent || "";

    const frag = new DOMParser().parseFromString(descRaw, "text/html");
    const posterSrc = frag.querySelector("img")?.getAttribute("src") || "";
    const blurb = frag.body?.textContent?.trim() || "";

    const rating = (descRaw.match(/★+/) || [""])[0];
    const rewatch = /rewatch/i.test(blurb) || /class="rewatch"/i.test(descRaw); // proxy sometimes signals in text/html
    const dateStr = pub ? new Date(pub).toLocaleDateString(undefined, {month:"short", day:"numeric", year:"numeric"}) : "";

    const card = document.createElement("article");
    card.className = "lb-item";
    card.setAttribute("role","listitem");

    const hit = document.createElement("a");
    hit.className = "lb-hit";
    hit.href = link; hit.target="_blank"; hit.rel="noopener";
    hit.ariaLabel = `Open review: ${title}`;

    const poster = document.createElement("div");
    poster.className = "lb-poster";
    poster.innerHTML = posterSrc ? `<img alt="" loading="lazy" decoding="async" src="${posterSrc}">` : "";

    const body = document.createElement("div");
    body.className = "lb-body";

    const titleRow = document.createElement("div");
    titleRow.className = "lb-title-row";
    titleRow.innerHTML = `
      <a href="${link}" target="_blank" rel="noopener">${title}</a>
      ${rating ? `<span class="lb-rating" aria-label="Rating">${rating}${rewatch ? ' · <span title="Rewatch" aria-label="Rewatch">⟲</span>' : ''}</span>` : rewatch ? `<span class="lb-rating" title="Rewatch" aria-label="Rewatch">⟲</span>` : ``}
    `;

    const descEl = document.createElement("div");
    descEl.className = "lb-desc";
    descEl.dataset.full = blurb; // stash full text
    descEl.dataset.link = link;

    const meta = document.createElement("div");
    meta.className = "lb-meta";
    meta.innerHTML = `${dateStr ? `Reviewed on ${dateStr} · ` : ``}<a href="${link}" target="_blank" rel="noopener">View on Letterboxd →</a>`;

    body.appendChild(titleRow);
    body.appendChild(descEl);
    body.appendChild(meta);

    card.appendChild(hit);
    card.appendChild(poster);
    card.appendChild(body);
    root.appendChild(card);

    cards.push(card);
   });

   // ——— Truncate with “see more…” inserted inline at the break (no jitter)
   function truncateToLines(el, lines = 5){
    const full = el.dataset.full || "";
    if(!full){ el.textContent = ""; return; }

    // set to full text first
    el.textContent = full;

    const cs = getComputedStyle(el);
    const lh = parseFloat(cs.lineHeight) || (parseFloat(cs.fontSize) * 1.5);
    const maxH = Math.round(lh * lines + 1);

    // If fits, leave as-is
    if(el.scrollHeight <= maxH){ return; }

    const link = el.dataset.link || "#";
    const see = document.createElement("span");
    see.className = "lb-more";
    see.innerHTML = ` <a href="${link}" target="_blank" rel="noopener">see more…</a>`;

    // Binary search the cutoff
    let lo = 0, hi = full.length, best = 0;
    while(lo <= hi){
     const mid = (lo + hi) >> 1;
     el.textContent = full.slice(0, mid).trim().replace(/[.,;:!?\-–—\s]+$/,"");
     el.appendChild(see);
     if(el.scrollHeight <= maxH){ best = mid; lo = mid + 1; }
     else { hi = mid - 1; }
     el.removeChild(see);
    }

    // Commit the best slice with the link
    el.textContent = full.slice(0, best).trim().replace(/[.,;:!?\-–—\s]+$/,"");
    el.appendChild(see);
   }

   // Initial truncate (after layout)
   function applyTruncation(){
    root.querySelectorAll(".lb-desc").forEach(d => truncateToLines(d, parseInt(getComputedStyle(document.querySelector('.letterboxd-reviews'))?.getPropertyValue('--lb-max-lines')) || 5));
   }
   // Run after next frame so sizes are final
   requestAnimationFrame(applyTruncation);
   // Re-truncate on resize (debounced)
   let tR = 0;
   addEventListener('resize', () => { clearTimeout(tR); tR = setTimeout(applyTruncation, 120); }, {passive:true});

   // ——— Carousel controls (snap + arrows + dots)
   const updateDots = () => {
    const children = [...root.children];
    const viewportLeft = root.scrollLeft + 2; // fudge
    const widths = children.map(c => c.getBoundingClientRect().width + parseFloat(getComputedStyle(root).gap || 0));
    // Find nearest index by scrollLeft / childWidth clusters
    let accum = 0, idx = 0;
    for(let i=0;i<widths.length;i++){ if(accum + widths[i]/2 > viewportLeft){ idx = i; break; } accum += widths[i]; }
    dotsWrap.querySelectorAll('.lb-dot').forEach((d,i)=> d.setAttribute('aria-current', i===idx ? 'true' : 'false'));
   };

   // Build dots
   dotsWrap.innerHTML = "";
   cards.forEach((_, i) => {
    const dot = document.createElement('button');
    dot.className = 'lb-dot';
    dot.type = 'button';
    dot.setAttribute('role','tab');
    dot.setAttribute('aria-label', `Go to review ${i+1}`);
    dot.addEventListener('click', () => {
     cards[i].scrollIntoView({behavior:'smooth', inline:'start', block:'nearest'});
    });
    dotsWrap.appendChild(dot);
   });
   updateDots();

   // Arrow behavior: scroll by ~ one tile
   function scrollByCard(dir = 1){
    const first = cards[0];
    const w = first ? (first.getBoundingClientRect().width + parseFloat(getComputedStyle(root).gap || 0)) : 320;
    root.scrollBy({left: dir * w, behavior: 'smooth'});
   }
   btnPrev.addEventListener('click', ()=> scrollByCard(-1));
   btnNext.addEventListener('click', ()=> scrollByCard(1));

   // Update dots on scroll & after snaps
   let raf = 0;
   root.addEventListener('scroll', () => {
    if(raf) return;
    raf = requestAnimationFrame(()=>{ updateDots(); raf = 0; });
   }, {passive:true});

   // Keyboard help on the scroller
   root.addEventListener('keydown', (e)=>{
    if(e.key === 'ArrowRight'){ e.preventDefault(); scrollByCard(1); }
    if(e.key === 'ArrowLeft'){ e.preventDefault(); scrollByCard(-1); }
   });

  })();
 </script>
</section>
</div>